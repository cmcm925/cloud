<!doctype html>

<html lang="ko">
    <head>
        <title>클라우드 공동인증서 서비스</title>
        <meta charset="UTF-8">
        <meta name="description" content="">
        <meta name="author" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link rel="stylesheet" href="/cloud/v1/styles/css/tsign_cloud_style.css">
    </head>

<body>
    <script src="/cloud/v1/js/jquery-3.6.0.min.js"></script>
    <script src="/cloud/v1/js/lib/jsrose_crypto.js"></script>
    <script src="/cloud/v1/js/lib/jsrose.js"></script>
    <script src="/cloud/v1/js/lib/aes.js"></script>    
    <script src="/cloud/v1/js/lib/cloudWeb.js"></script>


<!-- 클라우드인증 전체 감싸는 DIV START -->
<div id="tsignCloudBgWrapper" style="display:block;">

    <nav class="pushy pushy-left" data-focus="#first-link" aria-labelledby="navigation-area1">
        <h1 class="wa-hide" id="navigation-area1">네비게이션 영역</h1>
        <div class="pushy-content">
            <ul class="mftlist">
                <li>
                    <h2 class="tit">계정</h2>
                    <ul>
                        <li class="pushy-link"><a href="#" title="연결끊기" id="mDisconnect" class="big-link" data-reveal-id="disconnect_modal" role="button">연결끊기</a></li>
                        <li class="pushy-link"><a href="#" title="자동연결조회" id="mDelAutoconnect" role="button">자동연결조회</a></li>
                        <li class="pushy-link"><a href="#" title="계정탈퇴하기" id="mDeleteAccount" role="button">계정탈퇴하기</a></li>
                    </ul>
                </li>
                <li>
                    <h2 class="tit">고객지원</h2>
                    <ul>
                        <li class="pushy-link"><a href="#" title="새창열림" target="_blank">이용안내</a></li>
                        <li class="pushy-link"><a href="#" title="새창열림" target="_blank">고객센터</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>
    <!-- Site Overlay -->
    <div class="site-overlay"></div>
    <div class="certWrap">
        <div class="screenblock" id="screen_block"></div>
        <div class="loadingblock" id="loading_block"><div class="ldrSpinner"></div></div>
        <a href="#" title="클라우드인증 창닫기" id="close" class="closeBtn big-link" data-reveal-id="close_modal" role="button">
            <span> </span>
            <span> </span>
        </a>
        <div id="container">
            <button type="button" class="menu-btn" title="메뉴토글버튼">
                <span> </span>
                <span> </span>
                <span> </span>
            </button>
            <a href="#" class="closeBtn closeBtn2 big-link" data-reveal-id="close_modal" title="클라우드인증 창닫기" role="button">
                <span> </span>
                <span> </span>
            </a>
            <a href="#" class="prevBtn" title="뒤로가기" style="display: none;" role="button">
                <span> </span>
                <span> </span>
                <span> </span>
            </a>
            <main class="crtfCont" id="content">
                <div class="ui_content">
                    <p class="userTit fntClr1"><span class="fnt14bd">장*</span>님의 클라우드 공동인증서비스</p>
                    <h1 class="fntBold">인증서 파일 가져오기(PC)</h1>
                    <div class="pcImtBox">
                        <p>인증서 파일(*.pfx, *.p12, signCert.der/signPri.key)을 선택하여 클라우드 인증서를 사용할 수 있습니다. <span class="underLine">아래 2가지 방법 중 한가지를 이용</span>하여 인증서를 선택한 후 비밀번호를 입력하시기 바랍니다</p>
                        <h4 class="fntClr1">하나, 인증서 파일을 끌어다 놓기</h4>
                        <div class="fileArea">이 영역 안에 인증서 파일을 끌어다 놓으세요</div>
                        <h4 class="fntClr1">둘, 인증서 파일을 직접 선택</h4>
                        <p>인증서 파일 경로 :C: 사용자  사용자명  AppData  LocalLow  NPKI  SignKorea  User</p>
                        <div class="intFilebox">
                            <p>파일경로</p>
                            <div class="filebox bs3-primary">
                                <input class="upload-name" value="파일을 선택해주세요" title="선택된파일명" disabled="disabled"><input type="file" id="ex_filename" title="파일 선택" class="upload-hidden" multiple="multiple" accept=".pfx,.p12,.der,.key"><label for="ex_filename">파일</label> 
                            </div>
                        </div>
                    </div>
                    <div class="btnWrap">
                        <a href="#" class="cancelBtn bckClr3 brdrClr1 fntClr1" title="취소" role="button">취소</a><a href="#" class="okBtn bckClr7 brdrClr1 fntClr5" title="확인" role="button">확인</a>
                    </div>
                </div>
            </main>
            <nav class="footer bckClr6" aria-labelledby="navigation-area2">
                <h1 class="wa-hide" id="navigation-area2">네비게이션 영역</h1>
                <ul class="ftlist">
                    <li>
                        <h2 class="tit fntClr3">계정</h2>
                        <ul>
                            <li><a href="#" class="fntClr3 big-link" title="연결끊기" id="disconnect" data-reveal-id="disconnect_modal" role="button">연결끊기</a></li>
                            <li><a href="#" class="fntClr3" title="자동연결조회" id="delAutoconnect" role="button">자동연결조회</a></li>
                            <li><a href="#" class="fntClr3" title="계정탈퇴하기" id="deleteAccount" role="button">계정탈퇴하기</a></li>
                        </ul>
                    </li>
                    <li>
                        <h2 class="tit fntClr3">고객지원</h2>
                        <ul>
                            <li><a href="#" title="새창열림" class="fntClr3" target="_blank">이용안내</a></li>
                            <li><a href="#" title="새창열림" class="fntClr3" target="_blank">고객센터</a></li>
                        </ul>
                    </li>
                </ul>
                <div id="footer_unenable" class="bckClr6" style="display: none;position: absolute; inset: 89% 0% 5%; z-index: 9999; opacity: 0.5; border-radius: 0px 0px 15px 15px;"></div>
            </nav>
        </div>
    </div>
    
    <div id="modal1" class="reveal-modal" role="alertdialog" aria-modal="true" aria-labelledby="TITLE-modal1" aria-describedby="DESC-modal1">
        <h6 class="wa-hide" id="TITLE-modal1">알림창</h6>
        <p id="DESC-modal1"></p>
        <div class="ppBtnWrap2"><a href="#" title="확인" class="ppOkBtn close-reveal-modal" role="button">확인</a></div>
    </div>
    <div id="modal2" class="reveal-modal" role="alertdialog" aria-modal="true" aria-labelledby="TITLE-modal2" aria-describedby="DESC-modal2">
        <h6 class="wa-hide" id="TITLE-modal2">알림창</h6>
        <p id="DESC-modal2"></p>
        <div class="ppBtnWrap">
            <a href="#" title="취소" class="ppCnclBtn close-reveal-modal" role="button">취소</a>
            <a href="#" title="확인" class="ppOkBtn close-reveal-modal" role="button">확인</a>
        </div>
    </div>
    <div id="modal3" class="reveal-modal" role="alertdialog" aria-modal="true" aria-labelledby="TITLE-modal3" aria-describedby="DESC-modal3">
        <h6 class="wa-hide" id="TITLE-modal3">알림창</h6>
        <p id="DESC-modal3"></p>
        <div class="ppBtnWrap2"><a href="#" title="확인" class="ppOkBtn close-reveal-modal" role="button">확인</a></div>
    </div>
    
    <div id="close_modal" class="reveal-modal" role="alertdialog" aria-modal="true" aria-labelledby="TITLE-close_modal" aria-describedby="DESC-close_modal">
        <h6 class="wa-hide" id="TITLE-close_modal">알림창</h6>
        <p id="DESC-close_modal">클라우드 서비스를 종료하시겠습니까?</p>
        <div class="ppBtnWrap">
            <a id="closeCancelBtn" href="#" title="취소" class="ppCnclBtn close-reveal-modal" role="button">취소</a>
            <a id="closeOkBtn" title="확인" onclick="messageSend('close');" href="#" class="ppOkBtn close-reveal-modal" role="button">확인</a>
        </div> 
    </div>
    
    <div id="disconnect_modal" class="reveal-modal" role="alertdialog" aria-modal="true" aria-labelledby="TITLE-disconnect_modal" aria-describedby="DESC-disconnect_modal">
        <h6 class="wa-hide" id="TITLE-disconnect_modal">알림창</h6>
        <p id="DESC-disconnect_modal">클라우드 연결을 끊습니다<br>(자동연결이 해제됩니다)</p>
        <div class="ppBtnWrap">
            <a id="disconnectCancelBtn" title="취소" href="#" class="ppCnclBtn close-reveal-modal" role="button">취소</a>
            <a id="disconnectOkBtn" title="확인" href="#" class="ppOkBtn close-reveal-modal" role="button">확인</a>
        </div> 
    </div>
    
    <div id="autoconnect_modal" class="reveal-modal" role="alertdialog" aria-modal="true">
    </div>
    
    <div id="myModal" class="reveal-modal" role="alertdialog" aria-modal="true" aria-labelledby="TITLE-myModal" aria-describedby="DESC-myModal">
        <h6 class="wa-hide" id="TITLE-myModal">알림창</h6>
        <p id="DESC-myModal">이동식디스크 종류를 선택해주세요</p>
        <ul class="removableDiskList">
        </ul>

        <div class="ppBtnWrap">
           <a href="#" class="ppCnclBtn close-reveal-modal" role="button">취소</a>
           <a href="#" class="ppOkBtn close-reveal-modal" role="button">확인</a>
        </div> 
    </div>

    <div id="unlock_modal" class="reveal-modal" role="alertdialog" aria-modal="true" aria-labelledby="TITLE-unlock_modal" aria-describedby="DESC-unlock_modal">
        <h6 class="wa-hide" id="TITLE-unlock_modal">알림창</h6>
        <p id="DESC-unlock_modal">인증서 잠금을 해제하시겠습니까?</p>
        <div class="ppBtnWrap">
            <a href="#" class="ppCnclBtn close-reveal-modal" role="button">취소</a>
            <a href="#" class="ppOkBtn close-reveal-modal" role="button">확인</a>
         </div> 
    </div>
    
    <script src="/cloud/v1/styles/js/pushy.min.js"></script>
    <script src="/cloud/v1/styles/js/jquery.reveal.js"></script>     
    <iframe name='yettie_library_iframe' id='yettie_library_iframe'></iframe>

</div>
<!-- 클라우드인증 전체 감싸는 DIV END -->

<script>

    /************************************************************
     * ts5Log.js 에서 가져옴
     * 
     * *********************************************************/
    var ts5Log = (function () {
      var logLevel = 0;

      var init = function init(options) {
        logLevel = options.common.logLevel;
        rolling(options.common.logRollingCount);
      }

      var error = function error(msg) {
        this.writeLog(0, msg instanceof Error ? msg.toString() : msg);
      }

      var warn = function warn(msg) {
        this.writeLog(1, msg);
      }

      var info = function info(msg) {
        this.writeLog(2, msg);
      }

      var log = function log(msg) {
        this.writeLog(3, msg);
      }

      function writeLog(level, msg) {
        if (level > logLevel) return ;

        var logTypes = {
          0: 'Error',
          1: 'Warn',
          2: 'Info',
          3: 'Log',
        };

        var logType = logTypes[level];
      
        // Console Print
        //var logData = ts5Util.getTimeString(new Date()) + ' [' + logType + '] ';
        //logData += msg.slice(0, 5) === 'Error' ? msg.slice(5) : msg;
        //console[logType.toLowerCase()](logData);
        
        // Store Log
        //var log = getLog();
        //var date = ts5Util.getDateString(new Date());
        //log[date] = (log[date] || '') + logData + '\n';
        //setLog(log);
      };

      /**
       * get log from local Storage
       * @returns {Object} JSON parsed log data if exist or {};
       */
      var getLog = function getLog() {
        return JSON.parse(localStorage.getItem('log')) || {};
      };

      /**
       * 
       * @param {Object} log log object Key(8-digit date) - Value(Log Text) pairs
       */
      var setLog = function setLog(log) {
        typeof log === 'object' && localStorage.setItem('log', JSON.stringify(log));
      };

      /**
       * get Log by Date
       * @param {String} date 8-digit Date String (YYYYMMDD)
       * @returns {String} Log Strings for Specified Date
       */
      var getLogByDate = function getLogByDate(date) {
        var log = getLog();
        return log.hasOwnProperty(date) ? log[date] : '';
      };

      /**
       * save Log as File
       * @param {String} date 8-digit Date String (YYYYMMDD)
       */
      var saveLogAsFile = function saveLogAsFile(date) {
        var textToWrite = getLogByDate(date);
        var fileNameToSaveAs = "log(" + date + ").txt";
        var textFileAsBlob = new Blob([textToWrite], {type: 'text/plain'});

        if (navigator.appVersion.toString().indexOf('.NET') > 0) { // IE 11
          window.navigator.msSaveBlob(textFileAsBlob, fileNameToSaveAs);
        } else {
          // Chrome
          var downloadLink = document.createElement("a");
          downloadLink.download = fileNameToSaveAs;
          downloadLink.innerHTML = "Hidden Download Link";

          // allow code to work in webkit & Gecko based browsers
          window.URL = window.URL || window.webkitURL;

          downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
          downloadLink.onclick = destroyClickedElement;
          downloadLink.style.display = "none";
          document.body.appendChild(downloadLink);

          downloadLink.click();
        }
      };

      function destroyClickedElement(event) {
        document.body.removeChild(event.target);
      }

      var rolling = function rolling(rollingDays) {
        var today = new Date();
        var daysAgo = new Date();

        var log = getLog();
        var logKeys = Object.keys(log);
        var logKey;

        for (var i = 0; i < rollingDays; i++) {
          daysAgo.setDate(today.getDate() - i);
          logKey = ts5Util.getDateString(daysAgo);
          if (logKeys.indexOf(logKey) >= 0) delete log[logKey];
        }
        setLog(log);
      }

      return {
        init:init,
        error:error,
        warn:warn,
        info:info,
        log:log,
        writeLog:writeLog,
        getLog:getLog,
        getLogByDate:getLogByDate,
        setLog:setLog,
        saveLogAsFile:saveLogAsFile,
        rolling:rolling,
      };
    })();


    /************************************************************
     * ts5BrowserCert.js 에서 가져옴
     * ts5BrowserCert 변수명 대신 ts5CloudCert 로 적용
     * *********************************************************/

    var ts5CloudCert = {
        getBase64FromFile : function (file, id) {
            var reader = new FileReader();
            var content;

            reader.readAsDataURL(file);
            
            reader.onload = function () {
              // TODO: check the role of #id
              content = reader.result.split(',')[1];
              // $('#' + id).val(content);
              if (id.toLowerCase() === 'kmcert') {
                ts5CloudCert.kmCertPem = content;
              } else if (id.toLowerCase() === 'kmpri') {
                ts5CloudCert.kmPriPem = content;
              } else if (id.toLowerCase() === 'signcert') {
                ts5CloudCert.certPem = content;
              } else if (id.toLowerCase() === 'signpri') {
                ts5CloudCert.priPem = content;
              } else if (id.toLowerCase() === 'p12b64') {
                ts5CloudCert.p12B64 = content;
              }
            };

            reader.onerror = function () {
              ts5Log.error(reader.error);
              throw reader.error;
            };
        },

        fileLoad : function (event) {
            var fileNames;
            try {
              //인증서 처리
              var files = event.target.files;
              if (!files) return;
              
              if (files.length === 1) {
                certType = 1;
                fileNames = ['pfx', 'p12'];
                
                if (fileNames.indexOf(files[0].name.split('.')[1].toLowerCase()) < 0) {
                  throw Error('사용 가능한 파일이 아닙니다.');
                } else {
                  ts5CloudCert.getBase64FromFile(files[0], 'p12B64');
                }
              } else if (files.length === 2) {
                certType = 2;
                fileNames = ['signcert.der', 'signpri.key'];
                if (fileNames.indexOf(files[0].name.toLowerCase()) < 0 || fileNames.indexOf(files[1].name.toLowerCase()) < 0) {
                  throw Error('사용 가능한 파일이 아닙니다.');
                }

                for (var i = 0; i < files.length; i ++) {
                  ts5CloudCert.getBase64FromFile(files[i], files[i].name.split('.')[0]);
                }
              } else if (files.length === 4) {
                certType = 4;
                fileNames = ['kmcert.der', 'kmpri.key', 'signcert.der', 'signpri.key'];
                
                for (var i = 0; i < files.length; i ++) if (fileNames.indexOf(files[i].name.toLowerCase()) < 0) {
                  throw Error('사용 가능한 파일이 아닙니다.');
                }
                
                for (var i = 0; i < files.length; i ++) ts5CloudCert.getBase64FromFile(files[i], files[i].name.split('.')[0]);
              } else {
                throw Error('사용 가능한 파일이 아닙니다.');
              }
              return certType;
            } catch(e) {
              ts5Log.error(e);
              alert("아래 형태인 경우만 브라우저 인증서 등록이 가능합니다.\n\n- *.pfx (1개 파일)\n- *.p12 (1개 파일)\n- signCert.der, signPri.key (2개 파일)\n- kmCert.der, kmPri.key (2개 파일)\n- signCert.der, signPri.key, kmCert.der, kmPri.key (4개 파일)");
              return;
            }
        }
    }


    /************************************************************
     * ts5UI.js 에서 가져옴
     * ImportDirectView.prototype 에 적용된 부분
     * *********************************************************/

    $(function(){
        var DOM = $("#container");
        
        DOM.find('.fileArea')
        .on('drag dragstart dragend dragover dragenter dragleave drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
        })
        .on('dragover dragenter', function () {
            $(this).addClass('is-dragover');
        })
        .on('dragleave dragend drop', function () {
            $(this).removeClass('is-dragover');
        })
        .on('drop', function (e) {
            var files = e.originalEvent.dataTransfer;
            if (ts5CloudCert.fileLoad({target: files}) != null) {
                /* 정상적인 파일일때 실행 */
                alert('정상적인 파일입니다. 암호입력 화면으로')
            }
        });
    });
</script>
</body>

</html>
